platform: linux

image_resource:
  type: docker-image
  source:
    repository: cfcli/cli-package

inputs:
- name: certificates

params:
  AWS_ACCESS_KEY_ID:
  AWS_RELEASES_PATH:
  AWS_RELEASES_PATH_V7:
  AWS_RPM_PATH:
  AWS_SECRET_ACCESS_KEY:
  GPG_KEY_LOCATION:

run:
  path: bash
  args:
  - -c
  - |
    set -e
    cat<<EOF >sign-repodata

    #!/usr/bin/expect -f
    spawn gpg --detach-sign --armor repodata/repomd.xml
    expect -exact "Enter pass phrase: "
    send -- "\r"
    expect eof
    EOF
    chmod 700 sign-repodata

    mkdir gpg-dir
    export GNUPGHOME=$PWD/gpg-dir
    chmod 700 $GNUPGHOME
    trap "rm -rf $GNUPGHOME" 0

    gpg --import certificates/$GPG_KEY_LOCATION

    aws s3 sync \
      --exclude "*" \
      --include "releases/*/*installer*.rpm" \
      s3://${AWS_RELEASES_PATH} \
      .

    aws s3 sync \
      --exclude "*" \
      --include "releases/*/*installer*.rpm" \
      s3://${AWS_RELEASES_PATH_V7} \
      .

    createrepo -s sha .
    # ./sign-repodata

    aws s3 sync \
      --delete \
      repodata \
      s3://${AWS_RPM_PATH}/repodata
