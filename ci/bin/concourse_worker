#!/usr/bin/env bash

set -exv

echo "Starting Concourse Worker $(/bin/date) as $(/usr/bin/whoami)"

if [[ $(/usr/bin/whoami) != "root" ]]; then
  echo "sudo $HOME/workspace/cli-ci/ci/bin/concourse_worker"
  exit 1
fi

concourse_tsa="ci.cli.fun"
concourse_port="2222"
concourse_team="main"
concourse_pub_key="$HOME/.ssh/tsa_id_rsa.pub"
concourse_pvt_key="$HOME/.ssh/worker_id_rsa"

#TODO: extract into the separate setup script and run only once during the worker setup
/usr/bin/ssh-keyscan -p "$concourse_port" "$concourse_tsa" | awk '{print $2 " " $3}' > "$concourse_pub_key"

test -s "$concourse_pub_key" || exit 1

/usr/local/bin/concourse worker \
  --work-dir "/usr/local/var/concourse" \
  --team "$concourse_team" \
  --tsa-host "$concourse_tsa":"$concourse_port" \
  --tsa-public-key "$concourse_pub_key" \
  --tsa-worker-private-key "$concourse_pvt_key" \
  --tag "mac-pro"
